define(['module','jquery','underscore','Interactiv4_Storefront/js/utils/ready-aware','jsComponentUtils','Magento_Ui/js/lib/view/utils/dom-observer','Interactiv4_StorefrontLogger/js/logger/console-logger'],function(module,$,_,readyAware,jsComponentUtils,domObserver,consoleLogger){'use strict';return jsComponentUtils.resolveReturn({nodeUpdatedCallbacks:[],initialize:function(config){_.extend(this,config);$(()=>{this.initRoleBindings();this.initDataBindings();consoleLogger.debug('Storefront html data applier is ready');this.setReady();});this.awaitReady().then(()=>{const scheduledPolling=()=>{window.requestIdleCallback(()=>{this.ensureRoleBindings();this.ensureDataBindings();setTimeout(scheduledPolling,this.polling_frequency);});};setTimeout(scheduledPolling,this.polling_frequency);});},initRoleBindings:function(context){context=context||document;let htmlRoleDefinitions=_.where(this.html_role_definitions||[],{parent_role:$(context).attr('data-role')||''});htmlRoleDefinitions.forEach(htmlRoleDefinition=>{domObserver.get(htmlRoleDefinition.html_selector,node=>{this.setRoleBinding(node,htmlRoleDefinition);this.initRoleBindings(node);},context);});},ensureRoleBindings:function(){(this.html_role_definitions||[]).forEach(htmlRoleDefinition=>{$(htmlRoleDefinition.html_selector,!_.isEmpty(htmlRoleDefinition.parent_role)?this.wrapRoleForSelector(htmlRoleDefinition.parent_role):document).get().forEach(node=>{if($(node).attr('data-role')!==htmlRoleDefinition.role_value){this.setRoleBinding(node,htmlRoleDefinition);}});});},setRoleBinding:function(node,htmlRoleDefinition){let allowOverrideOriginalRole=this.allow_override_original_role||false,roleErrorNotifiedFlag='role-error-notified',handledByInteractiv4Flag='handled-by-interactiv4',nodeRole=$(node).attr('data-role'),definitionRole=htmlRoleDefinition.role_value;if(!allowOverrideOriginalRole&&!$(node).data(handledByInteractiv4Flag)&&!_.isUndefined(nodeRole)){if(!$(node).data(roleErrorNotifiedFlag)&&nodeRole!==definitionRole){$(node).data(roleErrorNotifiedFlag,1);consoleLogger.warn('Coward refusal to override existing data role: previous data role, new data role, element',nodeRole,definitionRole,node);consoleLogger.warn(`You may want to adapt configuration to match ${nodeRole} item role`);}
return;}
if(nodeRole!==definitionRole){$(node).data(handledByInteractiv4Flag,1);$(node).attr('data-role',definitionRole);this.notifyNodeUpdated(node);}},initDataBindings:function(){(this.html_data_definitions||[]).forEach(htmlDataDefinition=>{let parentSelector=!_.isEmpty(htmlDataDefinition.parent_role)?`${this.wrapRoleForSelector(htmlDataDefinition.parent_role)} `:'';domObserver.get(parentSelector+htmlDataDefinition.html_selector,node=>{this.setDataBinding(node,htmlDataDefinition);},document);});},ensureDataBindings:function(){(this.html_data_definitions||[]).forEach(htmlDataDefinition=>{$(htmlDataDefinition.html_selector,!_.isEmpty(htmlDataDefinition.parent_role)?this.wrapDataForSelector(htmlDataDefinition.parent_role):document).get().forEach(node=>{if($(node).attr(`data-${htmlDataDefinition.data_attribute}`)!==htmlDataDefinition.value){this.setDataBinding(node,htmlDataDefinition);}});});},setDataBinding:function(node,htmlDataDefinition){let definitionDataAttribute=htmlDataDefinition.data_attribute,definitionValue=htmlDataDefinition.value,definitionSelector=htmlDataDefinition.html_selector;if(!_.isString(definitionValue)){return;}
let isIncrementalValue=!!definitionValue.match(/\${n}/g);if(!isIncrementalValue){$(node).attr('data-'+definitionDataAttribute,definitionValue);this.notifyNodeUpdated(node);}
if(isIncrementalValue){let n=1,context=$(node).closest(this.wrapRoleForSelector(htmlDataDefinition.parent_role)).get(0)||document;context.querySelectorAll(definitionSelector).forEach(childNode=>{$(childNode).attr('data-'+definitionDataAttribute,definitionValue.replace('${n}',n++));this.notifyNodeUpdated(childNode);});}},notifyNodeUpdated:function(node){this.nodeUpdatedCallbacks.forEach(callbackDefinition=>{window.requestIdleCallback(()=>{try{callbackDefinition.callback(node);}catch(err){consoleLogger.error(err);}},callbackDefinition.options);});},onNodeUpdate:function(callback,maxExecutionDelay){this.nodeUpdatedCallbacks.push({callback:callback,options:maxExecutionDelay?{timeout:maxExecutionDelay}:{}});},wrapRoleForSelector:function(role){return this.wrapDataForSelector('role',role);},wrapDataForSelector:function(dataAttribute,dataValue){return`[data-${dataAttribute}${_.isUndefined(dataValue) ? '' : `='${dataValue}'`}]`;}},module.config(),readyAware);});