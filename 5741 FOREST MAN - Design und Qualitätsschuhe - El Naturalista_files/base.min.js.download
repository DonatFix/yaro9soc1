define(["jquery",'mage/url','mage/storage'],function($,url,storage){'use strict';return{initialize:function(categoryList,relatedList,crossellList,upsellList,widgetList,searchList,currencyCode,productCrossellClass,productUpsellClass,productRelatedClass,categoryTypeClass,relatedTypeClass,crossellTypeClass,upsellTypeClass,widgetTypeClass,productListGridClass,productListLinkClass,productListAddToCartClass,productListPriceBlockClass,productViewAddToCartClass,productViewSwatcherClasses,productViewPriceBlockClass,isCategoryPage,isSearchPage,isProductPage,isCheckoutCart,customerSessionVars,crumbs,isCheckout,variantAttribute,dimensionNumberForConfigurable){this.categoryList=categoryList;this.relatedList=relatedList;this.crossellList=crossellList;this.upsellList=upsellList;this.widgetList=widgetList;this.searchList=searchList;this.currencyCode=currencyCode;this.productCrossellClass=productCrossellClass;this.productUpsellClass=productUpsellClass;this.productRelatedClass=productRelatedClass;this.categoryTypeClass=categoryTypeClass;this.relatedTypeClass=relatedTypeClass;this.crossellTypeClass=crossellTypeClass;this.upsellTypeClass=upsellTypeClass;this.widgetTypeClass=widgetTypeClass;this.productListGridClass=productListGridClass;this.productListLinkClass=productListLinkClass;this.productListAddToCartClass=productListAddToCartClass;this.productListPriceBlockClass=productListPriceBlockClass;this.productViewAddToCartClass=productViewAddToCartClass;this.productViewPriceBlockClass=productViewPriceBlockClass;this.productViewSwatcherClasses=productViewSwatcherClasses;this.isCategoryPage=isCategoryPage;this.isSearchPage=isSearchPage;this.isProductPage=isProductPage;this.ischeckoutCart=isCheckoutCart;this.crumbs=crumbs;this.isCheckout=isCheckout;this.variantAttribute=variantAttribute;this.dimensionNumberForConfigurable=dimensionNumberForConfigurable;this.customerSessionVars=customerSessionVars;this.catalogSearchProductListJson=null;this.categoryProductWidgetListJson=null;this.categoryProductListJson=null;this.catalogProductViewCrossellJson=null;this.catalogProductViewRelatedJson=null;this.catalogProductViewUpsellJson=null;this.catalogProductViewJson=null;this.suscribeAddToCartAction();this.checkoutCartProductCrossellListJson=null;this.productsWidgets={};this.startBackendEvents();this.startEvents();},addProductWidget:function(productData){if(this.productsWidgets[productData.list]==undefined){this.productsWidgets[productData.list]={};}
this.productsWidgets[productData.list][productData.product_id]=productData;},setCategoryProductWidgetListJson:function(productsJson){if(productsJson.length>0){this.categoryProductWidgetListJson=productsJson;}},setCategoryProductListJson:function(productsJson){if(productsJson.length>0){this.categoryProductListJson=productsJson;}},setCatalogProductViewJson:function(productsJson){this.catalogProductViewJson=productsJson;},setCatalogProductViewRelatedJson:function(productsJson){this.catalogProductViewRelatedJson=productsJson;},setCatalogProductViewUpsellJson:function(productsJson){this.catalogProductViewUpsellJson=productsJson;},setCatalogProductViewCrossellJson:function(productsJson){this.catalogProductViewCrossellJson=productsJson;},setCatalogSearchProductListJson:function(productsJson){this.catalogSearchProductListJson=productsJson;},setCheckoutProductCrossellListJson:function(productsJson){this.checkoutCartProductCrossellListJson=productsJson;},setCheckoutProductCartListJson:function(productsJson){this.checkoutCartProductCartListJson=productsJson;},startBackendEvents:function(){if(this.customerSessionVars){window.dataLayer=window.dataLayer||[];var customerSessions=JSON.parse(this.customerSessionVars);$.each(customerSessions,function(pos,event){dataLayer.push(event);});}},getWidgetProducts:function(){var products=[];$.each(window.dataLayer,function(e){if(this.event=="impressionsCatalogWidgetList"){products.push(this)}});return products},startEvents:function(){this.saveCrumbs();var self=this;if(!self.isCheckout){localStorage.removeItem('existSession');}
localStorage.removeItem('productClickSended');$('.widget'+this.widgetTypeClass).bind("click",this.widgetProductClick.bind(this));$(this.productListLinkClass).bind("click",this.productListClick.bind(this));$("[data-event='productView']").bind("click",function(e){self.productListClick(e);self.widgetProductClick(e);});$(this.productCrossellClass).bind("click",this.crossellProductClick.bind(this));$(this.productUpsellClass).bind("click",this.upsellProductClick.bind(this));$(this.productRelatedClass).bind("click",this.relatedProductClick.bind(this));$(this.productViewAddToCartClass).bind("click",function(){if(self.isProductPage){let qty=jQuery(':radio[name=qty]:checked, [name=qty]').eq(0).val();let product=self.getProductJson();self.addToCartAction(product,qty,'Product Page');}});$(this.productListAddToCartClass).bind("click",function(){if($(this).length>0){let qty=jQuery(':radio[name=qty]:checked, [name=qty]').eq(0).val();if(!qty)qty=1;var div=$(this).closest('div'+self.productListGridClass);var ol=$(this).closest('ol');var li=$(this).closest('li');var widgetLength=$(this).parents(".widget").length;if(div&&ol&&li){var priceBlock=$(li).find(self.productListPriceBlockClass);if(priceBlock.length>0){var productId=priceBlock.data('product-id');if(self.isCategoryPage){var productJsonList=self.getProductJsonByClass(ol);$.each(productJsonList,function(){if(this.product_id==productId){return self.addToCartAction(this,qty,'Category List');}});}
if(self.isSearchPage){var productJsonList=self.catalogSearchProductListJson;$.each(productJsonList,function(){if(this.product_id==productId){return self.addToCartAction(this,qty,'Catalog Search');}});}
if(self.crumbs=='home'){if(!self.addToCartWidget(this,productId,qty)){return true;}}
if(self.crumbs==''){var sended=false;if(!self.addToCartWidget(this,productId,qty)){sended=true;return true;}
$.each(self.checkoutCartProductCrossellListJson,function(){if(this.product_id==productId&&!sended){sended=true;return self.addToCartAction(this,qty,'Crossell Products');}});}}}}});},crossellProductClick:function(e){this.genericRelatedProductClick(e.target,this.checkoutCartProductCrossellListJson,'Cart Crossell Product List');},upsellProductClick:function(e){this.genericRelatedProductClick(e.target,this.catalogProductViewUpsellJson,'Upsell Product List');},relatedProductClick:function(e){this.genericRelatedProductClick(e.target,this.catalogProductViewRelatedJson,'Related Product List');},genericRelatedProductClick:function(obj,listJson,productListName){var li=$(obj).find('li');var priceBlock=$(li).find(this.productListPriceBlockClass);var productId=priceBlock.data('product-id');var self=this;$.each(listJson,function(){if(this.product_id==productId){self.sendProductClick(this,productListName);return false;}});},widgetProductClick:function(e){var obj=e.target;var div=$(obj).closest('div'+this.productListGridClass);var ol=$(obj).closest('ol');var li=$(div).find('li');var sended=false;if(!jQuery(obj).parent().hasClass('tocart')&&!sended){var self=this;if(div&&ol&&li){var priceBlock=$(li).find(self.productListPriceBlockClass);if(priceBlock.length>0){var productId=priceBlock.data('product-id');var products=self.getWidgetProducts();$.each(products,function(event){$.each(this.ecommerce.impressions,function(event2){if(this.product_id==productId&&!sended){sended=true;self.sendProductClick(this,this.list);return false;}});});}}}},productListClick:function(e){var obj=e.target;var div=$(obj).closest('div'+this.productListGridClass);var ol=$(obj).closest('ol');var li=$(obj).closest('li');if(div&&ol&&li){var priceBlock=$(li).find(this.productListPriceBlockClass);var self=this;if(priceBlock.length>0){var productId=priceBlock.data('product-id');if(self.isCategoryPage){var productJsonList=self.getProductJsonByClass(ol);var productListName=self.getListNameByClass(ol);if(!productJsonList&&!productListName){var productJsonList=self.categoryProductWidgetListJson;}}else if(self.isProductPage){var productJsonList=self.getProductJsonByClass(div);var productListName=self.getListNameByClass(div);if(!productJsonList&&!productListName){var productJsonList=self.categoryProductWidgetListJson;}}else if(self.ischeckoutCart){var productJsonList='';if(!productJsonList&&!productListName){var productJsonList=self.categoryProductWidgetListJson;}}else if(self.isSearchPage){var productJsonList=self.catalogSearchProductListJson;var productListName='Catalog Search';if(!productJsonList&&!productListName){var productJsonList=self.categoryProductWidgetListJson;}}else{var productJsonList=self.categoryProductWidgetListJson;}
$.each(productJsonList,function(){if(this.product_id==productId&&!localStorage.productClickSended){localStorage.setItem('productClickSended','1');self.sendProductClick(this,productListName);return false;}});}}},addToCartWidget:function(obj,productId,qty){let widgetId=$(obj).parents('.widget_continer').attr('id');if(this.productsWidgets[widgetId]!=undefined&&this.productsWidgets[widgetId][productId]!=undefined){return this.addToCartAction(this.createProductToImpresion(this.productsWidgets[widgetId][productId],qty,widgetId));}
return true;},cloneObject:function(obj){let copy=Object.assign({},obj);delete copy['product_id'];return copy;},suscribeAddToCartAction:function(){self=this;$('.minicart__showcart').bind('DOMSubtreeModified',function(){if($('.minicart__counter.counter').length){$('.minicart__showcart').unbind('DOMSubtreeModified');$('.minicart__counter.counter').bind('DOMSubtreeModified',function(){self.sendAddToCartAction(localStorage);});self.sendAddToCartAction(localStorage);}});},sendAddToCartAction:function(localStorage){self=this;let urlAddress=url.build("/rest/V1/enhancedecommerce/addToCart");storage.get(urlAddress).done(function(response){if(response&&response.length>0){let dataJson=JSON.parse(response);$.each(dataJson,function(pos,data){if(data.isNew==1){self.addToCartNew(data);}else{self.addCartEvent(data);}});}}).fail(function(response){console.log("response api error");});},addToCartNew:function(data){var list=localStorage.getItem('addToCartList');if(list==='undefined'||list==null){return;}
var category=localStorage.getItem('addToCartCategory');if(category){data.category=category;}
delete data['isNew'];self.sendProductAddToCart(data,list);localStorage.removeItem('addToCartList')
localStorage.removeItem('addToCartCategory')},addCartEvent:function(event){dataLayer.push(event);},addToCartAction:function(productData,qty,list){var localStorage=window.localStorage;localStorage.setItem('addToCartList',list);localStorage.setItem('addToCartCategory',productData.category);return true;},saveCrumbs:function(){if(this.isCategoryPage||this.isProductPage){var payload={request:{crumbs:this.crumbs}};storage.post(url.build("/rest/V1/enhancedecommerce/crumbs"),JSON.stringify(payload)).done(function(response){}).fail(function(response){});}},getProductJson:function(){return this.catalogProductViewJson;},getProductJsonByClass:function(element){if($(element).is(this.widgetTypeClass)){return this.categoryProductWidgetListJson;}
if($(element).is(this.categoryTypeClass)){return this.categoryProductListJson;}
if($(element).is(this.relatedTypeClass)){return this.catalogProductViewRelatedJson;}
if($(element).is(this.crossellTypeClass)){return this.catalogProductViewCrossellJson;}
if($(element).is(this.upsellTypeClass)){return this.catalogProductViewUpsellJson;}},getListNameByClass:function(element){if($(element).is(this.widgetTypeClass)){return this.widgetList;}
if($(element).is(this.categoryTypeClass)){return this.categoryList;}
if($(element).is(this.relatedTypeClass)){return this.relatedList;}
if($(element).is(this.crossellTypeClass)){return this.crossellList;}
if($(element).is(this.upsellTypeClass)){return this.upsellList;}},sendImpresionCatalogSearchList:function(){window.dataLayer=window.dataLayer||[];let searchListImpressions=this.createArrayToImpresion(this.catalogSearchProductListJson);if(searchListImpressions.length>0){dataLayer.push({"event":"impressionsCatalogSearchList","ecommerce":{"currencyCode":this.currencyCode,"impressions":searchListImpressions}});}},sendImpresionCatalogWidgetList:function(products){window.dataLayer=window.dataLayer||[];let widgetListImpressions=this.createArrayToImpresion(this.categoryProductWidgetListJson);dataLayer.push({"event":"impressionsCatalogWidgetList","ecommerce":{"currencyCode":this.currencyCode,"impressions":widgetListImpressions}});},createProductToImpresion:function(product){let obj={"name":product.name,"id":product.id,"brand":product.brand,"variant":product.variant,"category":product.category,"price":product.price,"position":product.position,"list":product.list};if(product.dimensions){let i=0;for(;i<product.dimensions;i++){obj['dimension'+(self.dimensionNumberForConfigurable+i)]="";}}
return obj;},createArrayToImpresion:function(items){let arrayToImpressions=new Array();let self=this;$.each(items,function(i,product){arrayToImpressions.push(self.createProductToImpresion(product));});return arrayToImpressions;},sendImpresionCategoryProductList:function(){window.dataLayer=window.dataLayer||[];let categoryImpressions=this.createArrayToImpresion(this.categoryProductListJson);if(categoryImpressions.length>0){dataLayer.push({"event":"impressionsProductList","ecommerce":{"currencyCode":this.currencyCode,"impressions":categoryImpressions}});}},sendImpresionCrosssellProductList:function(){window.dataLayer=window.dataLayer||[];let crossellImpressions=this.createArrayToImpresion(this.catalogProductViewCrossellJson);if(crossellImpressions.length>0){dataLayer.push({"event":"impressionsCrosssellProductList","ecommerce":{"currencyCode":this.currencyCode,"impressions":this.catalogProductViewCrossellJson}});}},sendImpresionRelatedProductList:function(){window.dataLayer=window.dataLayer||[];let relatedImpressions=this.createArrayToImpresion(this.catalogProductViewRelatedJson);if(relatedImpressions.length>0){dataLayer.push({"event":"impressionsRelatedProductList","ecommerce":{"currencyCode":this.currencyCode,"impressions":relatedImpressions}});}},sendImpresionUpsellProductList:function(){window.dataLayer=window.dataLayer||[];let upsellImpressions=this.createArrayToImpresion(this.catalogProductViewUpsellJson);if(upsellImpressions.length>0){dataLayer.push({"event":"impressionsUpsellProductList","ecommerce":{"currencyCode":this.currencyCode,"impressions":upsellImpressions}});}},sendImpresionProductDetail:function(){var product=this.catalogProductViewJson;window.dataLayer=window.dataLayer||[];let obj={"name":product.name,"id":product.id,"brand":product.brand,"variant":product.variant,"category":product.category,"price":product.price};if(product.dimensions){let i=0;for(;i<product.dimensions;i++){obj['dimension'+(this.dimensionNumberForConfigurable+i)]="";}}
dataLayer.push({"event":"impressionsProductDetail","ecommerce":{"detail":{"products":[obj]}}});},sendImpresionCrosssellCheckoutCart:function(){window.dataLayer=window.dataLayer||[];let crossellCheckoutImpressions=this.createArrayToImpresion(this.checkoutCartProductCrossellListJson);if(crossellCheckoutImpressions.length>0){dataLayer.push({"event":"impressionsCrosssellCheckoutCart","ecommerce":{"currencyCode":this.currencyCode,"impressions":crossellCheckoutImpressions}});}},sendImpresionCartCheckoutCart:function(){window.dataLayer=window.dataLayer||[];dataLayer.push({"event":"impressionsCartCheckoutCart","ecommerce":{"currencyCode":this.currencyCode,"impressions":this.checkoutCartProductCartListJson}});},sendProductClick:function(product,list){window.dataLayer=window.dataLayer||[];let obj={"name":product.name,"id":product.id,"price":product.price,"brand":product.brand,"variant":product.variant,"category":product.category,"position":product.position};if(typeof list=='undefined'){list=product.list;}
if(product.dimensions){let i=0;for(;i<product.dimensions;i++){obj['dimension'+(this.dimensionNumberForConfigurable+i)]="";}}
dataLayer.push({"event":"productClick","ecommerce":{"click":{"actionField":{"list":list},"products":[obj]}}});},sendProductAddToCart:function(product,list){window.dataLayer=window.dataLayer||[];delete product["configurable_products"];if(this.isProductPage){delete product["list"];delete product["position"];}
var obj={"event":"addToCart","ecommerce":{"currencyCode":this.currencyCode,"add":{}}};if(!this.isProductPage&&list!='Product Page'){obj.ecommerce.add={"actionField":{"list":list},"products":[product]};}else{obj.ecommerce.add={"products":[product]};}
dataLayer.push(obj);},sendCheckoutSuccess:function(order,products){var localStorage=window.localStorage;if(localStorage.getItem('flagStep')){localStorage.removeItem('flagStep')}
window.dataLayer=window.dataLayer||[];dataLayer.push({"event":"purchase",'ecommerce':{'purchase':{'actionField':{'id':order.id,'affiliation':order.affiliation,'revenue':order.revenue,'tax':order.tax,'shipping':order.shipping,'coupon':order.coupon},"products":products}}});}};});